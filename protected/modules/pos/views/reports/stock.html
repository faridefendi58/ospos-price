{% extends "layout.html" %}
{% block pagetitle %}
Stok Produk Per Outlet - {{ App.params.site_name }}
{% endblock %}

{% block content %}
<link href="{{ 'lib/bootstrap-table/dist/bootstrap-table.min.css' | admin_asset_url }}" rel="stylesheet" media="screen">
<div id="main_wrapper">
    <div class="page_bar clearfix">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="page_title">
                    {% if not outlet %}
                    Stok Per Outlet
                    {% else %}
                    Stok di Outlet {{ outlet.title }}
                    {% endif %}
                </h1>
                <p class="text-muted">Stok dan catatan aktifitas di outlet {{ outlet.title }}</p>
            </div>
            <div class="col-sm-3">
                <select id="outlet_from" name="Reports[outlet_id]" class="form-control select2" onchange="selectWH(this)">
                    <option value="0">- Pilih Outlet -</option>
                    {% for i, wh in outlets %}
                    <option value="{{ wh.id }}" {% if outlet and outlet.id == wh.id %}selected="selected"{% endif %}>{{ wh.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-3 text-right">
                <div id="reportrange" class="btn">
                    <i class="fa fa-calendar"></i>
                    {% if params.date_start %}
                    <span>{{ params.date_start | date("M d, Y") }} - {{ params.date_end | date("M d, Y") }}</span> <b class="caret"></b>
                    {% else %}
                    <span>{{ "now" | date("M d, Y") }} - {{ "now" | date("M d, Y") }}</span> <b class="caret"></b>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="page_content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">Sisa Stok</div>
                        <div class="panel-body">
                            <div id="dt_basic_wrapper" class="dataTables_wrapper form-inline no-footer table-responsive mt20" role="grid">
                                <table
                                        data-show-export="true"
                                        data-pagination="true"
                                        data-show-pagination-switch="true"
                                        data-search="true"
                                        data-toggle="table"
                                        data-url="{{ 'pos/reports/stock-info' | link }}/{{ outlet.id }}">
                                    <thead>
                                    <tr>
                                        <th data-sortable="true" data-field="item_id" data-align="center">Item ID</th>
                                        <th data-field="item_name">Item Name</th>
                                        <th data-formatter="roundqty" data-field="quantity" data-align="center">Quantity</th>
                                        <th data-formatter="TableActions" data-align="center">Action</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partial/right_menu.html' %}
<script src="{{ 'lib/bootstrap-table/src/bootstrap-table.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/export/bootstrap-table-export.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/mobile/bootstrap-table-mobile.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/locale/bootstrap-table-id-ID.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/file-saver.js/FileSaver.js' | admin_asset_url }}" type="text/javascript"></script>
<script src="{{ 'lib/tableExport.jquery.plugin/tableExport.min.js' | admin_asset_url }}"></script>
{% endblock %}
{% block endbodyjs %}
<script src="{{ 'lib/bootstrap-daterangepicker/daterangepicker.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/moment-js/moment.min.js' | admin_asset_url }}"></script>
<script type="text/javascript">
    $(function() {
        initDateRage();
        tisa_enhanced_select.init();
    });

    function initDateRage() {
        if($('#reportrange').length) {
            if( $(window).width() < 974 ) {
                var dropdownPos = 'right';
            } else {
                var dropdownPos = 'left';
            }
            $('#reportrange').daterangepicker({
                        opens: dropdownPos,
                        ranges: {
                            'Today': [moment(), moment()],
                            'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                        },
                        startDate: moment().subtract('days', 29),
                        endDate: moment(),
                        buttonClasses: ['btn','btn-sm']
                    },
                    function(start, end) {
                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                        setDateRange(start, end);
                    }
            );
        }
    }
    function setDateRange(start, end) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        var outlet = gup('outlet', loc);
        if (outlet && outlet.length > 0) {
            window.location.href = currentURL+'?outlet='+outlet+'&start='+start+'&end='+end;
        } else {
            window.location.href = currentURL+'?start='+start+'&end='+end;
        }
    }
    function gup( name, url ) {
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( url );
        return results == null ? null : results[1];
    }
    tisa_enhanced_select = {
        init: function() {
            if($('.select2').length) {
                $('.select2').select2({
                    allowClear: true,
                    placeholder: "Select..."
                });
            }
        }
    }
    function selectWH(dt) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        if ($(dt).val() && parseInt($(dt).val()) > 0) {
            var start = gup('start', loc);
            var end = gup('end', loc);
            if (start && start.length >0 && end && end.length > 0)
                window.location.href = currentURL+'?outlet='+$(dt).val()+'&start='+start+'&end='+end;
            else
                window.location.href = currentURL+'?outlet='+$(dt).val();
        }
        return false;
    }
    function TableActions (value, row, index) {
        var outlet_id = row.outlet_id;
        var item_id = row.item_id;
        var update_url = "{{ 'pos/products/update' | link }}/"+ item_id +"?outlet="+ outlet_id;
        $action = [
            '<a href="'+ update_url +'" title="Ubah Outlet"><i class="fa fa-pencil"></i></a> '
        ].join('');

        return $action;
    }
    function roundqty (data) {
        var decimalCount = 0, decimal = ",", thousands = ".";
        var total = 0;

        if (data.length > 0) {

            try {
                decimalCount = Math.abs(decimalCount);
                decimalCount = isNaN(decimalCount) ? 0 : decimalCount;

                const negativeSign = data < 0 ? "-" : "";

                var i = parseInt(data = Math.abs(Number(data) || 0).toFixed(decimalCount)).toString();
                var j = (i.length > 3) ? i.length % 3 : 0;

                return negativeSign + (j ? i.substr(0, j) + thousands : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands) + (decimalCount ? decimal + Math.abs(data - i).toFixed(decimalCount).slice(2) : "");
            } catch (e) {
                console.log(e)
            }
        }

        return '';
    }
</script>
{% endblock %}
