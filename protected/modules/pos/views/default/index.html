{% extends "layout.html" %}
{% block pagetitle %}
Dashboard - {{ App.name }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ 'lib/bootstrap-daterangepicker/daterangepicker-bs3.css' | admin_asset_url }}">
<!-- main content -->
<div id="main_wrapper">
    <div class="page_bar clearfix">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="page_title">Dashboard</h1>
                <p class="text-muted">Selamat datang di {{ App.params.site_name }}. Anda dapat menggunakan data berikut untuk melihat efektifitas halaman website Anda.</p>
            </div>
            <div class="col-sm-3">
                <select id="outlet_from" name="Reports[outlet_id]" class="form-control select2" onchange="selectWH(this)">
                    <option value="0">- Pilih Outlet -</option>
                    {% for i, wh in outlets %}
                    <option value="{{ wh.id }}" {% if outlet and outlet.id == wh.id %}selected="selected"{% endif %}>{{ wh.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-3 text-right">
                <div id="reportrange" class="btn">
                    <i class="fa fa-calendar"></i>
                    {% if params.date_start %}
                    <span>{{ params.date_start | date("M d, Y") }} - {{ params.date_end | date("M d, Y") }}</span> <b class="caret"></b>
                    {% else %}
                    <span>{{ "now" | date("M d, Y") }} - {{ "now" | date("M d, Y") }}</span> <b class="caret"></b>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="page_content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">Net revenue</div>
                        <div class="panel-body">
                            <div id="report_revenue_visits" class="chart" style="height:300px;width:100%"></div>
                            <script>
                                /*data_visits = [
                                    [1391814000000,1240],
                                    [1391900400000,1140]
                                ];*/
                                var arr_rev = [];
                                var rev_data = {
                                    label: "Revenue",
                                    data: JSON.parse('{{ revenue.data | json_encode }}'),
                                    points: {fillColor: '#fff'}
                                };
                                arr_rev.push(rev_data);
                            </script>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">How many orders?</div>
                        <div class="panel-body">
                            <div class="peity_stat clearfix">
                                <div class="pull-left">
                                    <h3 class="peity_text">{{ tot_transaction.total }} <small>({{ tot_transaction.detail[4].count | default(0) }} retur)</small></h3>
                                </div>
                                <div class="peity_holder pull-right">
                                    <span class="peity_line"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">Best sellers (top 10)</div>
                        <div class="panel-body panel_body_a">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Product Revenue</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for t, trans in transactions %}
                                <tr>
                                    <td>{{ trans.item_name }}</td>
                                    <td style="text-align: right;">{{ trans.product_revenue | number_format(2, ',', '.') }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partial/right_menu.html' %}
{% endblock %}
{% block endbodyjs %}
<script src="{{ 'lib/d3/d3.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/novus-nvd3/nv.d3.min.js' | admin_asset_url }}"></script>
<!-- flot charts-->
<script src="{{ 'lib/flot/jquery.flot.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.pie.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.resize.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.tooltip.min.js' | admin_asset_url }}"></script>
<!-- date range picker -->
<script src="{{ 'lib/bootstrap-daterangepicker/daterangepicker.js' | admin_asset_url }}"></script>
<!-- moment.js (date library) -->
<script src="{{ 'lib/moment-js/moment.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.time.min.js' | admin_asset_url }}"></script>
{% set page_views = vmodel.getPageViewInterval(params.date_from, params.date_to) %}
<script type="text/javascript">
    $(function() {
        // nvd3 charts
        tisa_nvd3_charts.cumulativeLine();
        tisa_flot_charts.device();
        //charts
        tisa_report_chart.revenue_visits();
        tisa_report_chart.revenue_sources();
        initDateRage();
    });
    tisa_nvd3_charts = {
        cumulativeLine: function() {
            if ($('#nvd3_cumulativeLine').length) {
                nv.addGraph(function() {
                    var chart = nv.models.cumulativeLineChart()
                            .useInteractiveGuideline(true)
                            .x(function(d) { return d[0] })
                            .y(function(d) { return d[1] })
                            .color(d3.scale.category20().range())
                            .transitionDuration(500)
                            .clipVoronoi(false);

                    chart.xAxis.tickFormat(function(d) {
                        return d3.time.format('%m/%d/%y')(new Date(d))
                    });

                    //chart.yAxis.tickFormat(d3.format(',.1%'));

                    d3.select('#nvd3_cumulativeLine svg').datum(cumulativeTestData()).call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });

                function cumulativeTestData() {
                    var page_view_data = JSON.parse('{{ page_views.pageview | json_encode }}');
                    var session_data = JSON.parse('{{ page_views.session | json_encode }}');
                    return [
                        {
                            key: "PageView",
                            color: "#1f77b4",
                            values: page_view_data,
                        },
                        {
                            key: "Session",
                            color: "#ff7f0e",
                            values: session_data
                        }
                    ];
                }
            }
        }
    }
    tisa_flot_charts = {
        device: function () {
            if ($('#flot_device').length) {
                function labelFormatter(label, series) {
                    return "<div class=\"chart_label\">" + Math.round(series.percent) + "%</div>";
                }

                $.plot('#flot_device', chart_device_data, {
                    series: {
                        pie: {
                            show: true,
                            radius: 3 / 4,
                            label: {
                                show: true,
                                radius: 0.54,
                                formatter: labelFormatter,
                            }
                        }
                    }
                });
            }
        },
    }
    function initDateRage() {
        if($('#reportrange').length) {
            if( $(window).width() < 974 ) {
                var dropdownPos = 'right';
            } else {
                var dropdownPos = 'left';
            }
            $('#reportrange').daterangepicker({
                        opens: dropdownPos,
                        ranges: {
                            'Today': [moment(), moment()],
                            'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                        },
                        startDate: moment().subtract('days', 29),
                        endDate: moment(),
                        buttonClasses: ['btn','btn-sm']
                    },
                    function(start, end) {
                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                        setDateRange(start, end);
                    }
            );
        }
    }
    function setDateRange(start, end) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        var outlet = gup('outlet', loc);
        if (outlet && outlet.length >0)
            window.location.href = currentURL+'?outlet='+outlet+'&start='+start+'&end='+end;
        else
            window.location.href = currentURL+'?start='+start+'&end='+end;
    }
    // charts
    tisa_report_chart = {
        revenue_visits : function() {
            if($('#report_revenue_visits').length) {

                function dolarFormatter(v, axis) {
                    return "$"+v.toFixed(axis.tickDecimals) ;
                }

                var chart_placeholder = $('#report_revenue_visits');

                var options = {
                    grid: {
                        clickable: true,
                        hoverable: true,
                        autoHighlight: true,
                        backgroundColor: null,
                        borderWidth: 0,
                        color: "#666",
                        labelMargin: 10,
                        axisMargin: 0,
                        mouseActiveRadius: 10,
                        minBorderMargin: 5
                    },
                    series: {
                        lines: {
                            show: true,
                            lineWidth: 3,
                            steps: false
                        },
                        points: {
                            show:true,
                            radius: 4,
                            symbol: "circle",
                            fill: true
                        }
                    },
                    tooltip: true,
                    tooltipOpts: {
                        content: "%y <small class=\"text-muted\">(%x)</small>",
                        shifts: {
                            x: 20,
                            y: 0
                        },
                        defaultTheme: false
                    },
                    xaxis: {
                        mode: "time"
                    },
                    yaxes: [
                        {
                            min:0,
                        },
                        {
                            min:0,
                            tickFormatter: dolarFormatter,
                            position: "right"
                        }
                    ],
                    legend: {
                        noColumns: 0,
                        position: "ne"
                    },
                    colors: ["#d35400","#34495e"],
                    shadowSize: 0
                };

                /*$.plot(chart_placeholder,[{
                    label: "Revenue 1",
                    data: data_visits,
                    points: {fillColor: '#fff'}
                },{
                    label: "Product Revenue",
                    data: data_visits,
                    points: {fillColor: '#fff'},
                    yaxis: 2
                }],options);*/
                $.plot(chart_placeholder, arr_rev, options);

            }
        },
        revenue_sources: function() {
            if ($('#report_revenue_sources').length) {
                function labelFormatter(label, series) {
                    return "<div class=\"chart_label\">" + Math.round(series.percent) + "%</div>";
                }
                $.plot('#report_revenue_sources', data_revenue_sources, {
                    series: {
                        pie: {
                            show: true,
                            radius: 3/4,
                            label: {
                                show: true,
                                radius: 0.54,
                                formatter: labelFormatter,
                            },
                            innerRadius: 0.35
                        }
                    },
                    legend: {
                        show: true,
                        noColumns: 0,
                        container:$("#report_revenue_sources_legend")
                    }
                });
            }
        }
    }
    function selectWH(dt) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        if ($(dt).val() && parseInt($(dt).val()) > 0) {
            var start = gup('start', loc);
            var end = gup('end', loc);
            if (start && start.length >0 && end && end.length > 0)
                window.location.href = currentURL+'?outlet='+$(dt).val()+'&start='+start+'&end='+end;
            else
                window.location.href = currentURL+'?outlet='+$(dt).val();
        }
        return false;
    }
    function gup( name, url ) {
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( url );
        return results == null ? null : results[1];
    }
</script>
{% endblock %}