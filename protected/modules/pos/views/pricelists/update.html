{% extends "layout.html" %}
{% block pagetitle %}
Kelola Daftar Harga - {{ App.params.site_name }}
{% endblock %}

{% block content %}
<link href="{{ 'lib/bootstrap-table/dist/bootstrap-table.min.css' | admin_asset_url }}" rel="stylesheet" media="screen">
<!-- main content -->
<div id="main_wrapper">
    <div class="page_bar clearfix">
        <div class="row">
            <div class="col-sm-7">
                <h1 class="page_title">Daftar Harga {{ pricelist.name }} <b>({{ pricelist.code}})</b> - {{ outlet.title }}</h1>
                <p class="text-muted">Kelola data daftar harga <b>({{ pricelist.code}})</b> di {{ outlet.title }}</p>
            </div>
            <div class="col-sm-5 text-right">
                <div class="row">
                    <div class="col-sm-8">
                        <select id="outlet_from" name="PriceLists[outlet_id]" class="form-control select2" onchange="selectOutlet(this)">
                            <option value="0">- Pilih Outlet -</option>
                            {% for i, wh in outlets %}
                            <option value="{{ wh.id }}" {% if outlet and outlet.id == wh.id %}selected="selected"{% endif %}>{{ wh.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-2">
                        <a class="btn btn-default" href="{{ 'pos/pricelists/view' | link }}">Daftar Outlet</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page_content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <ul class="nav nav-tabs main-tabs" id="tabs_a">
                                <li class="active">
                                    <a data-toggle="tab" href="#list">Daftar Harga Barang</a>
                                </li>
                                <li>
                                    <a data-toggle="tab" href="#upload">Upload Harga Barang (.xls)</a>
                                </li>
                            </ul>
                            <div class="tab-content" id="tabs_content_a">
                                <div id="list" class="tab-pane fade in active">
                                    <table data-show-export="true"
                                           data-page-list="ALL"
                                           data-show-pagination-switch="true"
                                           data-pagination="true"
                                           data-search="true"
                                           data-toggle="table"
                                           data-url="{{ 'pos/pricelists/price-list-data' | link }}/{{ pricelist.id }}?outlet={{ outlet.id }}">
                                        <thead>
                                        <tr>
                                            <th data-sortable="true" data-field="item_id">Item ID</th>
                                            <th data-field="name">Item Name</th>
                                            <th data-field="item_number">Barcode</th>
                                            <th data-field="pricelist_unit_price" data-formatter="moneyFormatter" data-align="right">Harga Jual</th>
                                            <th data-field="unit_price" data-formatter="moneyFormatter" data-align="right">Harga Jual Umum</th>
                                            <th data-formatter="TableActions" data-align="center">Action</th>
                                        </tr>
                                        </thead>
                                    </table>
                                </div>
                                <div id="upload" class="tab-pane fade">
                                    {% include 'pricelists/_upload.html' with {'outlet':outlet, 'pricelist':pricelist} %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partial/right_menu.html' %}
<script src="{{ 'lib/bootstrap-table/src/bootstrap-table.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/export/bootstrap-table-export.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/mobile/bootstrap-table-mobile.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/bootstrap-table/dist/locale/bootstrap-table-id-ID.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/file-saver.js/FileSaver.js' | admin_asset_url }}" type="text/javascript"></script>
<script src="{{ 'lib/tableExport.jquery.plugin/tableExport.min.js' | admin_asset_url }}"></script>

{% endblock %}
{% block endbodyjs %}
<script type="text/javascript">
    function hapus(data) {
        if (confirm('Anda yakin ingin menghapus item ini ?')) {
            var $this =  $(data);
            var url = $this.attr('href');
            $.ajax({
                'url': url,
                'type':'post',
                //'dataType': 'json',
                'success': function(data) {
                    if (data.status == 'success') {
                        $this.parent().parent().remove();
                    }
                }
            });
        }
        return false;
    }
    $(function () {
        if (window.location.hash) {
            var hash = window.location.hash.substring(1);
            if ($('a[href="#'+hash+'"]').length > 0)
                $('a[href="#'+hash+'"]').click();
        }
    });
    function moneyFormatter(data) {
        var decimalCount = 2, decimal = ",", thousands = ".";
        var total = 0;

        if (data.length > 0) {

            try {
                decimalCount = Math.abs(decimalCount);
                decimalCount = isNaN(decimalCount) ? 2 : decimalCount;

                const negativeSign = data < 0 ? "-" : "";

                var i = parseInt(data = Math.abs(Number(data) || 0).toFixed(decimalCount)).toString();
                var j = (i.length > 3) ? i.length % 3 : 0;

                return negativeSign + (j ? i.substr(0, j) + thousands : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands) + (decimalCount ? decimal + Math.abs(data - i).toFixed(decimalCount).slice(2) : "");
            } catch (e) {
                console.log(e)
            }
        }

        return '';
    };
    function TableActions (value, row, index) {
        var outlet_id = row.outlet_id;
        var id = row.id;
        var update_url = "{{ 'pos/pricelists/update-item' | link }}/"+ id +"?outlet="+ outlet_id;
        var delete_url = "{{ 'pos/pricelists/delete-item' | link }}/"+ id +"?outlet="+ outlet_id;
        $action = [
            '<a href="'+ update_url +'" title="Ubah Price"><i class="fa fa-pencil"></i></a> ',
            '<a href="'+ delete_url +'" class="return hapus(this);"><i class="fa fa-trash-o"></i></a>'
        ].join('');

        return $action;
    }
    function selectOutlet(dt) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        if ($(dt).val() && parseInt($(dt).val()) > 0) {
            window.location.href = currentURL +'?outlet='+$(dt).val();
        }
        return false;
    }
</script>
{% endblock %}
